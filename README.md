# Functional Safety LSP PoC

## Configuration

Create a file called `credentials.env` with the following contents;

```bash
export OPENAI_API_KEY="your-openai-key"
```

## Prerequisites

- VS Code
- Golang
- Node.js

```bash
git clone https://github.com/devlogixteam/Fuzz-LSP.git
cd Fuzz-LSP
```

## Setup

## Windows

Open CMD as Adminitrator and execute:

```shell
setx OPENAI_API_KEY "your-api-key" /m
```

**Build LSP Server (Written in Go):**

```shell
.\build.sh
```

*fuzz-lsp.exe* will be generated.

**Build LSP Client (Written in TypeScript):**

```shell
cd vscode
.\build.sh
.\run.sh
```

In the newly opened window, open the vscode/extension/client/src/extension.ts file and open debugger panel with **Ctrl+Shift+D** and launch client.

## Linux

**Setup environment variable:**

```bash
export OPENAI_API_KEY="your-api-key"
```

**Build LSP Server (Written in Go):**

```bash
.\build.sh
```

**Build LSP Client (Written in TypeScript):**

```bash
cd vscode
.\build.sh
.\run.sh
```

In the newly opened window, open the vscode/extension/client/src/extension.ts file and open debugger panel with **Ctrl+Shift+D** and launch client.

## Code Completion and Suggestion

This Visual Studio Code extension integrates with the Fuzz LSP (Language Server Protocol) to provide intelligent code suggestions directly in your editor. Code suggestions are displayed as inline, italicized text, similar to GitHub Copilot. You can accept suggestions using `Ctrl + Right Arrow` for seamless integration into your workflow.

## Features

- **Code Suggestions**: Receive code suggestions from the Fuzz LSP server.
- **Inline Display**: Suggestions are shown inline with a light grey, italicized text.
- **Keyboard Integration**: Accept suggestions with `Ctrl + Right Arrow`.

## Usage

1. **Start the Language Server**: The extension will automatically start the Fuzz LSP server when activated.
2. **Code Suggestions**: As you type, suggestions from the LSP server will be displayed in grey, italicized text ahead of your cursor.
3. **Accept Suggestions**: Press `Ctrl + Right Arrow` to accept the displayed code suggestion. The suggestion will be inserted into the editor at the current cursor position.

Notification method implemented in jsonrpc and integrated with the LSP server. It will notify the client with the code (generated by llm) and will be displayed on the editor and can be accepted with "Ctrl + Right Arrow" (because TAB is already being used to the accept the keyword completion).
Here, we are passing static response from backend.

While typing....<br>
![image](https://github.com/user-attachments/assets/ce3893e5-45c4-4d77-b494-2edcdb81f557)

After pressing, `Ctrl + Right Arrow`<br>
![image](https://github.com/user-attachments/assets/4a5d5701-94d0-4b4e-b771-431080e3d51a)

## Fuzz LSP UI:
Upon launching the LSP, one can fill this form and save setting to restart the LSP server with the updated configurations. Choose Fuzz LSP from side panel and config LSP:<br>
![image](https://github.com/user-attachments/assets/7c9be98e-7f06-41bd-b930-f8f3fc8c3165)

## Ollama in Pipeline
Ollama running on GitHub and getting direct responses from the model and generating JSON and html report. The binary code is written in `/src/llm-code-analysis.go` file. 
**Workflow File:** `./github/workflows/code-analysis.yml`
Just commit and push the branch `feature/completion-n-suggestion` and you will get the `report.json` and `report.html`

**report.json**<br>
![image (4)](https://github.com/user-attachments/assets/a9e8758d-47f7-472a-928a-c1fc878e69cd)
**report.html**<br>
![image (3)](https://github.com/user-attachments/assets/0c9bf738-370d-43ca-a02d-a54306e168f9)

## Code Actions
The Code Action feature in FuzzLSP provides intelligent code assistance, including refactoring suggestions and issue explanations. When diagnostics are available for the current line in the editor, the server can offer two types of code actions:

1. Ask LLM for Fix [FuzzLSP]: This action uses an LLM to provide a suggested refactor for the current line of code.
2. Explain Issue [FuzzLSP]: This action explains the problem with the current line of code, inserting an explanatory comment above the line.
### Key Functions
- OnCodeActionWithSliceCodeAction: Gathers relevant diagnostics based on the cursor's position and provides code actions if issues are detected.
- OnCodeActionResolve: Resolves a selected code action. For the "Ask LLM for Fix" action, the LLM suggests a refactor, while for the "Explain Issue" action, an explanation is added as a comment.
### Code Action Workflow
- Diagnostic Detection: When a diagnostic is detected on the current line, the server provides possible code actions such as refactoring or explaining the issue.
- User Selection: The user selects one of the provided actions.
- LLM Interaction:
    For refactoring, the LLM suggests a fix.
    For issue explanation, the LLM generates a comment explaining the problem.
- Apply Changes: The server applies the suggested changes or explanation to the user's document.
![image](https://github.com/user-attachments/assets/c2147385-b8e0-4da7-863b-1f2d89b3b5db)
